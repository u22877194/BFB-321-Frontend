<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Purchase Order - Inventory Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="../../css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            width: 260px;
            background: linear-gradient(180deg, #2c3e50 0%, #34495e 100%);
            padding: 0;
            transition: all 0.3s ease;
            z-index: 1000;
            overflow-y: auto;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }
        
        .sidebar.collapsed { width: 80px; }
        
        .sidebar-header {
            padding: 20px;
            background: rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            justify-content: space-between;
            color: white;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .sidebar-logo { display: flex; align-items: center; gap: 10px; }
        .sidebar-logo i { font-size: 24px; }
        .sidebar-header h4 { margin: 0; font-size: 18px; font-weight: 600; }
        .sidebar.collapsed .sidebar-header h4 { display: none; }
        
        .toggle-btn {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            padding: 5px;
        }
        
        .sidebar-menu { list-style: none; padding: 15px 0; }
        .menu-item { margin-bottom: 5px; }
        
        .menu-link {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            color: rgba(255,255,255,0.8);
            text-decoration: none;
            transition: all 0.3s;
        }
        
        .menu-link:hover { background: rgba(255,255,255,0.1); color: white; }
        
        .menu-link.active {
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-left: 4px solid #fff;
        }
        
        .menu-link i { font-size: 20px; width: 40px; text-align: center; }
        .menu-link span { margin-left: 10px; }
        .sidebar.collapsed .menu-link span { display: none; }
        
        .menu-section {
            padding: 15px 20px 5px;
            color: rgba(255,255,255,0.5);
            font-size: 12px;
            text-transform: uppercase;
            font-weight: 600;
        }
        
        .sidebar.collapsed .menu-section { display: none; }
        
        .main-content {
            margin-left: 260px;
            transition: all 0.3s ease;
            min-height: 100vh;
            background: #f5f6fa;
        }
        
        .main-content.expanded { margin-left: 80px; }
    </style>
</head>
<body>
    <!-- Sidebar (Same as other pages) -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-logo">
                <i class="bi bi-box-seam"></i>
                <h4>Inventory MS</h4>
            </div>
            <button class="toggle-btn" id="sidebarToggle">
                <i class="bi bi-list"></i>
            </button>
        </div>
        
        <ul class="sidebar-menu">
            <li class="menu-item">
                <a href="../../dashboard.html" class="menu-link">
                    <i class="bi bi-speedometer2"></i>
                    <span>Dashboard</span>
                </a>
            </li>
            
            <div class="menu-section">Inventory</div>
            
            <li class="menu-item">
                <a href="../products/products-list.html" class="menu-link">
                    <i class="bi bi-box"></i>
                    <span>Products</span>
                </a>
            </li>
            
            <li class="menu-item">
                <a href="../inventory/inventory-overview.html" class="menu-link">
                    <i class="bi bi-grid-3x3-gap"></i>
                    <span>Inventory Overview</span>
                </a>
            </li>
            
            <li class="menu-item">
                <a href="../categories/categories.html" class="menu-link">
                    <i class="bi bi-tags"></i>
                    <span>Categories</span>
                </a>
            </li>
            
            <div class="menu-section">Orders</div>
            
            <li class="menu-item">
                <a href="po-list.html" class="menu-link active">
                    <i class="bi bi-cart"></i>
                    <span>Purchase Orders</span>
                </a>
            </li>
            
            <li class="menu-item">
                <a href="../transfer-orders/transfer-list.html" class="menu-link">
                    <i class="bi bi-arrow-left-right"></i>
                    <span>Transfer Orders</span>
                </a>
            </li>
            
            <div class="menu-section">Management</div>
            
            <li class="menu-item">
                <a href="../locations/locations.html" class="menu-link">
                    <i class="bi bi-geo-alt"></i>
                    <span>Locations</span>
                </a>
            </li>
            
            <li class="menu-item">
                <a href="../suppliers/suppliers.html" class="menu-link">
                    <i class="bi bi-truck"></i>
                    <span>Suppliers</span>
                </a>
            </li>
            
            <li class="menu-item">
                <a href="../users/users.html" class="menu-link">
                    <i class="bi bi-people"></i>
                    <span>Users</span>
                </a>
            </li>
            
            <div class="menu-section">Reports</div>
            
            <li class="menu-item">
                <a href="../reports/stock-report.html" class="menu-link">
                    <i class="bi bi-bar-chart"></i>
                    <span>Stock Reports</span>
                </a>
            </li>
            
            <li class="menu-item">
                <a href="../reports/transaction-report.html" class="menu-link">
                    <i class="bi bi-file-earmark-text"></i>
                    <span>Transactions</span>
                </a>
            </li>
        </ul>
    </div>
    
    <!-- Main Content -->
    <div class="main-content" id="mainContent">
        <div style="padding: 30px;">
            <div style="background: white; padding: 25px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.08); margin-bottom: 25px;">
                <h1 style="font-size: 28px; font-weight: 700; color: #2c3e50;">Create Purchase Order</h1>
                <p style="color: #7f8c8d;">Fill in the details below to create a new purchase order</p>
            </div>
            
            <form id="createPOForm">
                <!-- PO Information -->
                <div style="background: white; padding: 25px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.08); margin-bottom: 20px;">
                    <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 20px; border-bottom: 2px solid #f0f0f0; padding-bottom: 10px;">
                        <i class="bi bi-info-circle me-2"></i>PO Information
                    </h3>
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label fw-semibold">PO Number</label>
                            <input type="text" class="form-control" id="poNumber" readonly style="background: #f8f9fa;">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-semibold">Supplier *</label>
                            <select class="form-select" id="supplierId" required>
                                <option value="">Loading suppliers...</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-semibold">Expected Delivery Date *</label>
                            <input type="date" class="form-control" id="expectedDate" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Destination Location *</label>
                            <select class="form-select" id="locationId" required>
                                <option value="">Loading locations...</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Order Date</label>
                            <input type="date" class="form-control" id="orderDate" required>
                        </div>
                        <div class="col-12">
                            <label class="form-label fw-semibold">Notes</label>
                            <textarea class="form-control" id="notes" rows="2" placeholder="Add any notes or special instructions"></textarea>
                        </div>
                    </div>
                </div>
                
                <!-- Order Items -->
                <div style="background: white; padding: 25px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.08); margin-bottom: 20px;">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h3 style="font-size: 18px; font-weight: 600; margin: 0;">
                            <i class="bi bi-list-ul me-2"></i>Order Items
                        </h3>
                        <button type="button" class="btn btn-sm btn-primary" onclick="addPOItem()">
                            <i class="bi bi-plus-circle me-1"></i>Add Item
                        </button>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table" id="poItemsTable">
                            <thead style="background: #f8f9fa;">
                                <tr>
                                    <th style="width: 35%;">Product</th>
                                    <th style="width: 20%;">Quantity</th>
                                    <th style="width: 20%;">Unit Price</th>
                                    <th style="width: 20%;">Total</th>
                                    <th style="width: 5%;"></th>
                                </tr>
                            </thead>
                            <tbody id="poItemsBody">
                                <!-- Items will be added here -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Order Summary -->
                <div style="background: white; padding: 25px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.08); margin-bottom: 20px;">
                    <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 20px;">Order Summary</h3>
                    <div class="row">
                        <div class="col-md-8"></div>
                        <div class="col-md-4">
                            <table class="table table-borderless">
                                <tr>
                                    <td><strong>Subtotal:</strong></td>
                                    <td class="text-end" id="subtotal">R0.00</td>
                                </tr>
                                <tr>
                                    <td><strong>Tax (15%):</strong></td>
                                    <td class="text-end" id="tax">R0.00</td>
                                </tr>
                                <tr style="border-top: 2px solid #000;">
                                    <td><strong style="font-size: 18px;">Grand Total:</strong></td>
                                    <td class="text-end"><strong style="font-size: 18px;" id="grandTotal">R0.00</strong></td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Actions -->
                <div style="background: white; padding: 25px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.08);">
                    <div class="d-flex justify-content-between">
                        <a href="po-list.html" class="btn btn-outline-secondary">Cancel</a>
                        <div class="d-flex gap-2">
                            <button type="button" class="btn btn-outline-primary" onclick="saveDraft()">Save as Draft</button>
                            <button type="submit" class="btn" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none;">
                                <i class="bi bi-check-circle me-2"></i>Submit PO
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../../js/main.js"></script>
    <script>
        let productsData = [];
        let suppliersData = [];
        let locationsData = [];
        
        function showNotification(message, type) {
            if (typeof InventoryMS !== 'undefined' && InventoryMS.showNotification) {
                InventoryMS.showNotification(message, type);
            } else {
                alert(message);
            }
        }
        
        document.addEventListener('DOMContentLoaded', async function() {
            await new Promise(resolve => setTimeout(resolve, 500));
            
            if (!currentUser || !currentUser.organization_id) {
                alert('Please log in');
                window.location.href = '../../index.html';
                return;
            }
            
            setDefaultDates();
            await loadSuppliers();
            await loadLocations();
            await loadProducts();
            await generatePONumber(); // Wait for unique PO number
            addPOItem(); // Add first row
        });
        
        async function generatePONumber() {
            try {
                // Generate with timestamp and random number for uniqueness
                const year = new Date().getFullYear();
                const timestamp = Date.now().toString().slice(-4);
                const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
                const poNumber = `PO-${year}-${timestamp}${random}`;
                
                // Check if this number already exists
                const { data, error } = await supabase
                    .from('purchase_orders')
                    .select('po_number')
                    .eq('organization_id', currentUser.organization_id)
                    .eq('po_number', poNumber)
                    .single();
                
                // If it exists, try again recursively
                if (data) {
                    console.log('PO number exists, generating new one...');
                    return await generatePONumber();
                }
                
                document.getElementById('poNumber').value = poNumber;
                
            } catch (error) {
                // If error is "no rows returned", that's good - number is unique
                if (error.code === 'PGRST116') {
                    // Number is unique, keep it
                    return;
                }
                console.error('Error generating PO number:', error);
            }
        }
        
        function setDefaultDates() {
            const today = new Date().toISOString().split('T')[0];
            const nextWeek = new Date(Date.now() + 7*24*60*60*1000).toISOString().split('T')[0];
            document.getElementById('orderDate').value = today;
            document.getElementById('expectedDate').value = nextWeek;
        }
        
        async function loadSuppliers() {
            try {
                const { data, error } = await supabase
                    .from('suppliers')
                    .select('id, name')
                    .eq('organization_id', currentUser.organization_id)
                    .eq('is_active', true)
                    .order('name');
                
                if (error) throw error;
                
                suppliersData = data || [];
                const select = document.getElementById('supplierId');
                select.innerHTML = '<option value="">Select Supplier</option>' + 
                    suppliersData.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
                
            } catch (error) {
                console.error('Error loading suppliers:', error);
            }
        }
        
        async function loadLocations() {
            try {
                const { data, error } = await supabase
                    .from('locations')
                    .select('id, name')
                    .eq('organization_id', currentUser.organization_id)
                    .eq('is_active', true)
                    .order('name');
                
                if (error) throw error;
                
                locationsData = data || [];
                const select = document.getElementById('locationId');
                select.innerHTML = '<option value="">Select Location</option>' + 
                    locationsData.map(l => `<option value="${l.id}">${l.name}</option>`).join('');
                
            } catch (error) {
                console.error('Error loading locations:', error);
            }
        }
        
        async function loadProducts() {
            try {
                const { data, error } = await supabase
                    .from('products')
                    .select('id, name, sku')
                    .eq('organization_id', currentUser.organization_id)
                    .eq('is_active', true)
                    .order('name');
                
                if (error) throw error;
                
                productsData = data || [];
                
            } catch (error) {
                console.error('Error loading products:', error);
            }
        }
        
        function addPOItem() {
            const tbody = document.getElementById('poItemsBody');
            const productOptions = productsData.map(p => 
                `<option value="${p.id}">${p.name} (${p.sku})</option>`
            ).join('');
            
            const newRow = document.createElement('tr');
            newRow.innerHTML = `
                <td>
                    <select class="form-select form-select-sm" required>
                        <option value="">Select Product</option>
                        ${productOptions}
                    </select>
                </td>
                <td><input type="number" class="form-control form-control-sm" value="1" min="1" step="0.01" onchange="calculateRowTotal(this)" required></td>
                <td><input type="number" class="form-control form-control-sm" value="0" step="0.01" min="0" onchange="calculateRowTotal(this)" required></td>
                <td><input type="text" class="form-control form-control-sm" value="R0.00" readonly style="background: #f8f9fa;"></td>
                <td><button type="button" class="btn btn-sm btn-outline-danger" onclick="removeRow(this)"><i class="bi bi-trash"></i></button></td>
            `;
            tbody.appendChild(newRow);
        }
        
        function removeRow(btn) {
            const tbody = document.getElementById('poItemsBody');
            if (tbody.rows.length > 1) {
                btn.closest('tr').remove();
                calculateTotal();
            }
        }
        
        function calculateRowTotal(input) {
            const row = input.closest('tr');
            const qty = parseFloat(row.querySelectorAll('input[type="number"]')[0].value) || 0;
            const price = parseFloat(row.querySelectorAll('input[type="number"]')[1].value) || 0;
            const total = qty * price;
            row.querySelector('input[readonly]').value = 'R' + total.toLocaleString('en-ZA', {minimumFractionDigits: 2});
            calculateTotal();
        }
        
        function calculateTotal() {
            let subtotal = 0;
            document.querySelectorAll('#poItemsBody tr').forEach(row => {
                const qty = parseFloat(row.querySelectorAll('input[type="number"]')[0].value) || 0;
                const price = parseFloat(row.querySelectorAll('input[type="number"]')[1].value) || 0;
                subtotal += qty * price;
            });
            const tax = subtotal * 0.15;
            const grandTotal = subtotal + tax;
            
            document.getElementById('subtotal').textContent = 'R' + subtotal.toLocaleString('en-ZA', {minimumFractionDigits: 2});
            document.getElementById('tax').textContent = 'R' + tax.toLocaleString('en-ZA', {minimumFractionDigits: 2});
            document.getElementById('grandTotal').textContent = 'R' + grandTotal.toLocaleString('en-ZA', {minimumFractionDigits: 2});
        }
        
        async function saveDraft() {
            await savePO('draft');
        }
        
        async function savePO(status) {
            // Get a valid user_id from the users table
            const { data: userData, error: userError } = await supabase
                .from('users')
                .select('id')
                .eq('organization_id', currentUser.organization_id)
                .eq('is_active', true)
                .limit(1)
                .single();
            
            if (userError || !userData) {
                showNotification('Error: No valid user found', 'danger');
                return;
            }
            
            const poData = {
                organization_id: currentUser.organization_id,
                supplier_id: document.getElementById('supplierId').value,
                location_id: document.getElementById('locationId').value,
                created_by: userData.id, // Use user from users table
                po_number: document.getElementById('poNumber').value,
                status: status,
                order_date: document.getElementById('orderDate').value,
                expected_date: document.getElementById('expectedDate').value,
                notes: document.getElementById('notes').value || null
            };
            
            if (!poData.supplier_id || !poData.location_id) {
                showNotification('Please fill in all required fields', 'warning');
                return;
            }
            
            // Get items
            const items = [];
            document.querySelectorAll('#poItemsBody tr').forEach(row => {
                const productSelect = row.querySelector('select');
                const qty = row.querySelectorAll('input[type="number"]')[0].value;
                const price = row.querySelectorAll('input[type="number"]')[1].value;
                
                if (productSelect.value && qty && price) {
                    items.push({
                        product_id: productSelect.value,
                        quantity_ordered: parseFloat(qty),
                        unit_price: parseFloat(price)
                    });
                }
            });
            
            if (items.length === 0) {
                showNotification('Please add at least one item', 'warning');
                return;
            }
            
            try {
                // Insert PO
                const { data: po, error: poError } = await supabase
                    .from('purchase_orders')
                    .insert([poData])
                    .select()
                    .single();
                
                if (poError) throw poError;
                
                // Insert items
                const itemsWithPOId = items.map(item => ({
                    ...item,
                    purchase_order_id: po.id
                }));
                
                const { error: itemsError } = await supabase
                    .from('purchase_order_items')
                    .insert(itemsWithPOId);
                
                if (itemsError) throw itemsError;
                
                showNotification(status === 'draft' ? 'PO saved as draft' : 'Purchase Order created successfully!', 'success');
                setTimeout(() => window.location.href = 'po-list.html', 1000);
                
            } catch (error) {
                console.error('Error saving PO:', error);
                showNotification('Error: ' + error.message, 'danger');
            }
        }
        
        document.getElementById('createPOForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            await savePO('submitted');
        });
        
        // Sidebar toggle
        document.getElementById('sidebarToggle').addEventListener('click', function() {
            document.getElementById('sidebar').classList.toggle('collapsed');
            document.getElementById('mainContent').classList.toggle('expanded');
        });
    </script>
</body>
</html>